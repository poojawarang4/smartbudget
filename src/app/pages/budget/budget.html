<div *ngIf="!budgetExistsForMonth">
  <div class="center-wrapper">
    <img src="assets/budget-icon.png" class="icon" />
    <h1>Hey there, looks like you need a budget for {{ selectedMonth }}.</h1>
    <button class="btn-green" (click)="startPlanningForMonth()">Start Planning for {{ selectedMonth }}</button>
    <button class="btn-green" *ngIf="hasAnyBudget" (click)="copyLatestBudgetForMonth()">Copy From Latest
      Budget</button>
  </div>
</div>

<div *ngIf="budgetExistsForMonth">
  <!-- your full app-budget page -->
  <div *ngIf="budgetExistsForMonth">
    <div class="layout">

      <!-- LEFT SIDE (SCROLL AREA) -->
      <div class="left-section card">
        <div class="left-scroll scroll-area">
          <!-- INCOME -->
          <div class="card">
            <div class="grid-header">
              <span>Income</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of income">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived">
                {{ item.received | currency:'INR' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Savings -->
        <div class="card">
          <div class="grid-table">
            <div class="grid-header">
              <span>Saving</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of savings">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned" [class.disabled]="!hasPlannedIncome()"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived" [ngClass]="getReceivedClass(item)">
                {{ getReceivedDisplay(item) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Giving -->
        <div class="card">
          <div class="grid-table">
            <div class="grid-header">
              <span>Giving</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of giving">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned" [class.disabled]="!hasPlannedIncome()"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived" [ngClass]="getReceivedClass(item)">
                {{ getReceivedDisplay(item) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Housing -->
        <div class="accordion-item" [class.open]="isOpen">
          <div class="accordion-header" (click)="toggle()">
            <h5>Housing</h5>
            <span class="arrow" [class.rotate]="isOpen">
              â–¼
            </span>
          </div>
          <div class="accordion-body">
            <!-- TABLE HEADER -->
            <div class="grid-table">
              <div class="grid-header">
                <span></span>
                <span>Planned</span>
                <span>Received</span>
              </div>
              <!-- TABLE ROWS -->
              <div class="grid-row" *ngFor="let item of housing">
                <span class="label">{{ item.name }}</span>
                <ng-container>
                  <span *ngIf="!item.editPlanned" class="amount clickable-amount" [class.disabled]="!hasPlannedIncome()"
                    (click)="editAmount(item, 'planned', false)">
                    {{ item.planned | currency:'INR' }}
                  </span>

                  <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                    (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item,'planned')" />
                </ng-container>

                <!-- Received -->
                <span class="amount" [ngClass]="getReceivedClass(item)">
                  {{ getReceivedDisplay(item) }}
                </span>

              </div>
            </div>
          </div>
        </div>

        <!-- Transportation -->
        <div class="accordion-item" [class.open]="isExp">
          <div class="accordion-header" (click)="togglet()">
            <h5>Transportation</h5>
            <span class="arrow" [class.rotate]="isExp">
              â–¼
            </span>
          </div>
          <div class="accordion-body">
            <!-- TABLE HEADER -->
            <div class="grid-table">
              <div class="grid-header">
                <span></span>
                <span>Planned</span>
                <span>Received</span>
              </div>
              <!-- TABLE ROWS -->
              <div class="grid-row" *ngFor="let item of tranportation">
                <span class="label">{{ item.name }}</span>
                <ng-container>
                  <span *ngIf="!item.editPlanned" class="amount clickable-amount" [class.disabled]="!hasPlannedIncome()"
                    (click)="editAmount(item, 'planned', false)">
                    {{ item.planned | currency:'INR' }}
                  </span>

                  <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                    (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item,'planned')" />
                </ng-container>

                <!-- Received -->
                <span class="amount" [ngClass]="getReceivedClass(item)">
                  {{ getReceivedDisplay(item) }}
                </span>

              </div>
            </div>
          </div>
        </div>

        <!-- Food -->
        <div class="accordion-item" [class.open]="isExpand">
          <div class="accordion-header" (click)="togglef()">
            <h5>Food</h5>
            <span class="arrow" [class.rotate]="isExpand">
              â–¼
            </span>
          </div>
          <div class="accordion-body">
            <!-- TABLE HEADER -->
            <div class="grid-table">
              <div class="grid-header">
                <span></span>
                <span>Planned</span>
                <span>Received</span>
              </div>
              <!-- TABLE ROWS -->
              <div class="grid-row" *ngFor="let item of food">
                <span class="label">{{ item.name }}</span>
                <ng-container>
                  <span *ngIf="!item.editPlanned" class="amount clickable-amount" [class.disabled]="!hasPlannedIncome()"
                    (click)="editAmount(item, 'planned', false)">
                    {{ item.planned | currency:'INR' }}
                  </span>

                  <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                    (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item,'planned')" />
                </ng-container>

                <!-- Received -->
                <span class="amount" [ngClass]="getReceivedClass(item)">
                  {{ getReceivedDisplay(item) }}
                </span>

              </div>
            </div>
          </div>
        </div>

        <!-- Personal -->
        <div class="card">
          <div class="grid-table">
            <div class="grid-header">
              <span>Personal</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of personal">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned" [class.disabled]="!hasPlannedIncome()"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived" [ngClass]="getReceivedClass(item)">
                {{ getReceivedDisplay(item) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Insurance -->
        <div class="accordion-item" [class.open]="isOpeni">
          <div class="accordion-header" (click)="togglei()">
            <h5>Insurance</h5>
            <span class="arrow" [class.rotate]="isOpeni">
              â–¼
            </span>
          </div>
          <div class="accordion-body">
            <!-- TABLE HEADER -->
            <div class="grid-table">
              <div class="grid-header">
                <span></span>
                <span>Planned</span>
                <span>Received</span>
              </div>
              <!-- TABLE ROWS -->
              <div class="grid-row" *ngFor="let item of insurance">
                <span class="label">{{ item.name }}</span>
                <ng-container>
                  <span *ngIf="!item.editPlanned" class="amount clickable-amount" [class.disabled]="!hasPlannedIncome()"
                    (click)="editAmount(item, 'planned', false)">
                    {{ item.planned | currency:'INR' }}
                  </span>

                  <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                    (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item,'planned')" />

                </ng-container>

                <!-- Received -->
                <span class="amount" [ngClass]="getReceivedClass(item)">
                  {{ getReceivedDisplay(item) }}
                </span>

              </div>
            </div>
          </div>
        </div>

        <!-- Loan Repayment -->
        <div class="card">
          <div class="grid-table">
            <div class="grid-header">
              <span>Loan Repayment</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of loan">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned" [class.disabled]="!hasPlannedIncome()"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived" [ngClass]="getReceivedClass(item)">
                {{ getReceivedDisplay(item) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Entertainment -->
        <div class="card">
          <div class="grid-table">
            <div class="grid-header">
              <span>Entertainment</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of entertainment">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned" [class.disabled]="!hasPlannedIncome()"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived" [ngClass]="getReceivedClass(item)">
                {{ getReceivedDisplay(item) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Child Care -->
        <div class="card">
          <div class="grid-table">
            <div class="grid-header">
              <span>Child Care</span>
              <span>Planned</span>
              <span>Received</span>
            </div>
            <div class="grid-row" *ngFor="let item of childcare">
              <span class="label">{{ item.name }}</span>

              <span class="amount clickable-amount" *ngIf="!item.editPlanned" [class.disabled]="!hasPlannedIncome()"
                (click)="editAmount(item, 'planned', true)">
                {{ item.planned | currency:'INR' }}
              </span>

              <input *ngIf="item.editPlanned" appAutoFocusDirective type="number" [(ngModel)]="item.planned"
                (blur)="finishEdit(item,'planned')" (keydown.enter)="finishEdit(item, 'planned')" />

              <span class="amount" *ngIf="!item.editReceived" [ngClass]="getReceivedClass(item)">
                {{ getReceivedDisplay(item) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE (FIXED BUDGET SUMMARY) -->
      <div class="right-section card">
        <div class="summary-fixed">

          <div class="tabs">
            <button [class.active]="activeTab === 'summary'" (click)="activeTab = 'summary'">Budget Summary</button>
            <button [class.active]="activeTab === 'transactions'"
              (click)="activeTab = 'transactions'">Transactions</button>
          </div>
          <div>
            <div *ngIf="activeTab === 'summary'" class="tab-pane">
              <h3>Budget Summary</h3>
              <div class="pie-chart-wrapper">
                <canvas baseChart [data]="pieChartData" [labels]="pieChartLabels" [options]="pieChartOptions"
                  [type]="'doughnut'">
                </canvas>
              </div>
              <div class="category-list" *ngIf="categoryDisplay.length > 0">
                <div class="category-row" *ngFor="let c of categoryDisplay">
                  <span class="dot" [style.backgroundColor]="c.color"></span>
                  <span class="name">{{ c.name }}</span>
                  <span class="percent">{{ c.percent }}%</span>
                </div>
              </div>
              <button class="reset-btn" (click)="openResetPopup()">âŸ³ Reset Budget</button>
              <app-reset-budget-popup *ngIf="showResetPopup" (closePopup)="showResetPopup = false"
                (makeZero)="resetAllAmountsToZero()" (copyLast)="copyLatestBudgetForMonth()">
              </app-reset-budget-popup>
            </div>
            <div *ngIf="activeTab === 'transactions'" class="tab-pane">
              <div class="page-wrapper">
                <div class="content">
                  <!-- Left: Transactions -->
                  <div class="transactions-box card">
                    <h3>Transactions</h3>
                    <div class="empty-state" *ngIf="transactions.length === 0">
                      <div class="empty-icon">ðŸ“­</div>
                      <h4>No transactions yet</h4>
                      <p>Add your first income or expense to see it here.</p>
                    </div>
                    <div class="transactions-scroll">
                      <div class="transaction-card" *ngFor="let t of transactions; let i = index"
                        (click)="editTransaction(t)">
                        <mat-grid-list cols="12" rowHeight="40px" class="transaction-grid">
                          <mat-grid-tile colspan="3" class="icon-circle">{{ t.date | date:'MMM dd'}}</mat-grid-tile>
                          <mat-grid-tile colspan="5" class="left-tile">{{ t.category }}</mat-grid-tile>
                          <mat-grid-tile colspan="4" class="amount-tile"> <span class="amount-text">
                              {{ t.amount | currency:'INR':'symbol':'1.0-0' }}
                            </span></mat-grid-tile>
                        </mat-grid-list>
                      </div>
                    </div>
                  </div>
                  <div class="confirm-overlay" *ngIf="showDeletePopup">
                    <div class="confirm-box">
                      <p>Are you sure want to delete this transaction?</p>
                      <div class="actions1">
                        <button class="yes" (click)="confirmDelete()">Yes</button>
                        <button class="no" (click)="cancelDelete()">No</button>
                      </div>
                    </div>
                  </div>
                  <button class="fab" (click)="openPopup(popupType)"> + </button>
                  <!-- Right: Summary -->
                  <div class="summary-box card">
                    <h3>Summary</h3>
                    <div class="empty-state" *ngIf="!summary || (summary | keyvalue).length === 0">
                      <div class="empty-icon">ðŸ“Š</div>
                      <h4>No summary available</h4>
                      <p>Summary will appear once transactions are added.</p>
                    </div>
                    <div class="transactions-scroll">
                      <div class="summary-card" *ngFor="let s of summary | keyvalue">
                        <mat-grid-list cols="12" rowHeight="40px" gutterSize="8px">
                          <!-- Row 1 : Category -->
                          <mat-grid-tile colspan="6">
                            <div class="category left-align">
                              {{ s.key }}
                            </div>
                          </mat-grid-tile>
                          <!-- Row 1 : Amount -->
                          <mat-grid-tile colspan="6">
                            <div class="value" [ngClass]="getProgressClass(s.value) + '-text'">
                              {{ s.value.spent | currency:'INR':'symbol':'1.0-0' }} Out of {{ s.value.allotted |
                              currency:'INR':'symbol':'1.0-0'}}
                            </div>
                          </mat-grid-tile>
                          <!-- Row 2 : Progress bar (full width) -->
                          <mat-grid-tile colspan="12">
                            <div class="progress">
                              <div class="progress-fill" [ngClass]="getProgressClass(s.value)"
                                [style.width.%]="getProgressPercent(s.value)">
                              </div>
                            </div>
                          </mat-grid-tile>
                        </mat-grid-list>
                      </div>
                    </div>
                  </div>

                  <!-- Popup -->
                  <div class="popup-backdrop" *ngIf="showPopup">
                    <div class="popup">
                      <div class="popup-header">
                        <h3>
                          {{ isEditMode
                          ? (popupType === 'income' ? 'Edit Income' : 'Edit Expense')
                          : (popupType === 'income' ? 'Add Income' : 'Add Expense') }}
                        </h3>
                        <span class="close" (click)="closePopup()">âœ•</span>
                      </div>
                      <div class="toggle">
                        <label>
                          <input type="radio" name="type" value="income" [(ngModel)]="popupType"
                            (change)="onTypeChange()" />
                          Income
                        </label>
                        <label>
                          <input type="radio" name="type" value="expense" [(ngModel)]="popupType"
                            (change)="onTypeChange()" />
                          Expense
                        </label>
                      </div>
                      <div class="form">
                        <div class="form-group">
                          <label>Category</label>
                          <select [(ngModel)]="form.category">
                            <option *ngFor="let c of selectedCategoryList">{{ c }}</option>
                          </select>
                        </div>
                        <div class="row">
                          <div class="form-group half">
                            <label>Amount</label>
                            <input type="number" [(ngModel)]="form.amount" />
                          </div>
                          <div class="form-group half">
                            <label>Date</label>
                            <input type="date" [(ngModel)]="form.date" />
                          </div>
                        </div>
                        <div class="form-group">
                          <label>Description</label>
                          <input type="text" [(ngModel)]="form.description"
                            [placeholder]="popupType==='income' ? 'Where did this money come from?' : 'Where did you spend this money?'" />
                        </div>
                        <div class="actions">
                          <button *ngIf="isEditMode" class="cancel" (click)="openDeletePopupFromEdit()">
                            Delete
                          </button>
                          <button class="cancel" (click)="closePopup()">Cancel</button>
                          <button class="submit" (click)="submitTransaction()">
                            {{ isEditMode ? 'Update' : (popupType === 'income' ? 'Add Income' : 'Add Expense') }}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- POPUP EDIT BOX -->
              <div class="left-toast" *ngIf="showLeftToast">
                {{ leftMessage }}
              </div>
            </div>
            <!-- <div *ngIf="activeTab === 'Categorised'" class="tab-pane">
              <canvas baseChart [data]="categoryTrendData" [type]="'line'" [options]="categoryTrendOptions">
              </canvas>
            </div> -->
            <div class="success-popup" *ngIf="successPopup">
              {{ successMessage }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>